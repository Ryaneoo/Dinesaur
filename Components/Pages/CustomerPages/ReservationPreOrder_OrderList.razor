@*Pre-Order Order List for Reservation*@
@page "/Reservation/OrderList/{id:int}"
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext


<div style="display: flex; flex-direction: column; padding: 30px; font-family: Consolas;">

    <h1>@selectedRestaurant?.RestaurantName</h1>
    <h2 style=" text-align:center;font-size: 50px;">Reservation Summary</h2>

<<<<<<< HEAD
    <div style="margin-top: 20px;color:white;font-size: 25px;text-align:center">
        <p><strong>Date:@selectedReservation?.Date.Value.Date</strong> </p>
        <p><strong>Time:@selectedReservation?.Time.Value.TimeOfDay</strong> </p>
=======
    <div style="margin-top: 20px;color:white;font-size: 35px;text-align:center">
        <p><strong>Date:@selectedReservation?.StartDate.ToShortDateString()</strong> </p>
        <p><strong>Time:@selectedReservation?.StartDate.ToShortTimeString()</strong> </p>
>>>>>>> fcf2b492b7698e08e6964cf4ac601581bc3a0d6f
        <p><strong>Pax:@selectedReservation?.Pax</strong></p>
        <p><strong>Location:@selectedRestaurant?.Location</strong></p>
    </div>

    <strong style="margin-top: 30px;font-size:35px;color:white">Pre‑Ordered Dishes:</strong>

    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background-color:black; color: white;">
            <tr>
                <th style="text-align: left; padding: 8px;">Dish</th>
                <th style="text-align: right; padding: 8px;">Price</th>
                <th style="text-align: right; padding: 8px;">Quantity</th>
                <th style="text-align: right; padding: 8px;">Cost</th>
            </tr>
        </thead>
        <tbody>
            @if (orderRows.Count == 0)
            {
                <tr style="color:white">
                    <td style="padding: 8px;" colspan="4">
                        No pre-ordered dishes.
                    </td>
                </tr>
            }
            else
            {
                @foreach(var r in orderRows)
                {
                      <tr style="color:white">
                    <td style="padding: 8px;font-size:20px;" >@r.Dish</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">$@r.Price</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">@r.Quantity</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">$@(r.Price* r.Quantity)</td>
                </tr>
                }
            }
        </tbody>
    </table>

    <p style="text-align: right; font-weight: bold; color:white;font-size:30px;">Total Cost: $@totalCost</p>

    <strong style="margin-top: 30px;font-size:35px;color:white;">Reservation Bill:</strong>

    <div style="text-align: right; color:white;font-size:20px;">
        <p>Pre‑Order Cost: $@totalCost</p>
        <p>Reservation Fee: $0.00</p>
        <p>Subtotal: $0.00</p>
        <p>GST (9%): $0.00</p>
        <p>Service Charge (10%): $0.00</p>
        <p style="font-weight: bold;">Grand Total: $@totalCost</p>
    </div>

    <button class="btn btn-success" style="margin-top: 30px;"onclick="@SaveAndGoHome">
        Confirm Booking
    </button>

</div>




@code {
    [Parameter]
    public int id { get; set; }

    public DateTime Date { get; set; }
    public TimeSpan Time { get; set; }
    public Reservation Reservation { get; set; } = new();
    private int? preOrderID;
    private List<OrderRow> orderRows = new();
    private double totalCost = 0;
    private double cost;
    Restaurant? selectedRestaurant;
    Reservation? selectedReservation;
    Menu? selectedMenu;

    private sealed class OrderRow
    {
        public string Dish { get; set; } = "";
        public double Price { get; set; }
        public int Quantity { get; set; }
    }
    protected override async Task OnInitializedAsync()
    {
        selectedReservation = DbContext.Reservation.FirstOrDefault(x => x.ReservationID == id);
        selectedRestaurant = selectedReservation != null ? await DbContext.Restaurant.FirstOrDefaultAsync(r => r.RestaurantID == selectedReservation.RestaurantID) : null;
        selectedMenu = selectedRestaurant != null ? await DbContext.Menu.FirstOrDefaultAsync(m => m.RestaurantID == selectedRestaurant.RestaurantID) : null;
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NavigationManager.NavigateTo("/Account/Login");
            return;
        }

        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        Reservation.CustomerID = aspNetUserId;

        await using var db = await DbFactory.CreateDbContextAsync();

        var preOrder = await db.PreOrder.FirstOrDefaultAsync(p => p.ReservationID == id);

        if (preOrder == null)
            return;

        preOrderID = preOrder.PreOrderID;

        orderRows = await (
        from poi in db.PreOrderItem
        join f in db.Food on poi.FoodID equals f.FoodID
        where poi.PreOrderID == preOrderID.Value
        select new OrderRow
        {
            Dish = f.FoodName,
            Price = f.Cost,
            Quantity = poi.Quantity
        }
    ).ToListAsync();

        totalCost = preOrder.Cost;


    }

    private async Task SaveAndGoHome()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        NavigationManager.NavigateTo("#");
        await db.SaveChangesAsync();
    }

        
    }


