@*Pre-Order Order List for Reservation*@
@page "/Reservation/OrderList/{id:int}"
@using Dinesaur.Data
@using Dinesaur.Domain
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext
@inject IJSRuntime JS


@inject UserManager<DinesaurUser> UserManager

<div style="display: flex; flex-direction: column; padding: 30px; font-family: Consolas;">

    <h1>@selectedRestaurant?.RestaurantName</h1>
    <h2 style=" text-align:center;font-size: 50px;">Reservation Summary</h2>

    <div style="margin-top: 20px;color:white;font-size: 25px;text-align:center">
        <p><strong>Date:@selectedReservation?.Date.Value.Date.ToString("dd MMMM yyyy")</strong> </p>
        <p><strong>Time:@selectedReservation?.Time.Value.ToString("h:mm tt")</strong> </p>
        <p><strong>Pax:@selectedReservation?.Pax</strong></p>
        <p><strong>Location:@selectedRestaurant?.Location</strong></p>
    </div>

    <strong style="margin-top: 30px;font-size:35px;color:white">Pre‑Ordered Dishes:</strong>

    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background-color:black; color: white;">
            <tr>
                <th style="text-align: left; padding: 8px;">Dish</th>
                <th style="text-align: right; padding: 8px;">Price</th>
                <th style="text-align: right; padding: 8px;">Quantity</th>
                <th style="text-align: right; padding: 8px;">Cost</th>
            </tr>
        </thead>
        <tbody>
            @if (orderRows.Count == 0)
            {
                <tr style="color:white">
                    <td style="padding: 8px;" colspan="4">
                        No pre-ordered dishes.
                    </td>
                </tr>
            }
            else
            {
                @foreach(var r in orderRows)
                {
                      <tr style="color:white">
                    <td style="padding: 8px;font-size:20px;" >@r.Dish</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">$@r.Price.ToString("F2")</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">@r.Quantity</td>
                        <td style="padding: 8px;text-align:right;font-size:20px;">$@((r.Price* r.Quantity).ToString("F2"))</td>
                </tr>
                }
            }
        </tbody>
    </table>

    <p style="text-align: right; font-weight: bold; color:white;font-size:30px;">Total Cost: $@totalCost.ToString("F2")</p>

    <strong style="margin-top: 30px;font-size:35px;color:white;">Reservation Bill:</strong>

    <div style="text-align: right; color:white;font-size:20px;">
        <p>Pre‑Order Cost: $@totalCost.ToString("F2")</p>
        <p>Reservation Fee: .00</p>
        <p>Subtotal: .00</p>
        <p>GST (9%): .00</p>
        <p>Service Charge (10%): .00</p>
        <p style="font-weight: bold;font-size:40px;">Grand Total: $@totalCost.ToString("F2")</p>
    </div>
    @if (CanEditPreOrder)
    {
        <button class="btn btn-success"
                style="margin-top: 30px; background-color: red;"
                @onclick="DeletePreOrder">
            Delete PreOrder
        </button>

        <button class="btn btn-success"
                style="margin-top: 30px;"
                @onclick="EditPreOrdering">
            Edit PreOrder
        </button>
    }

    <AuthorizeView Roles="RestaurantStaff">
        <Authorized>
            <button class="btn btn-success" style="margin-top: 30px;" onclick="@Back">
                Back
            </button>
        </Authorized>
    

    
   <NotAuthorized>
    <button class="btn btn-success" style="margin-top: 30px;" onclick="@SaveAndGoHome">
        Confirm
    </button>
        </NotAuthorized>
    </AuthorizeView>
</div>




@code {
    [Parameter]
    public int id { get; set; }

    public DateTime Date { get; set; }
    public TimeSpan Time { get; set; }
    public Reservation Reservation { get; set; } = new();
    private int? preOrderID;
    private List<OrderRow> orderRows = new();
    private double totalCost = 0;
    private double cost;
    Restaurant? selectedRestaurant;
    Reservation? selectedReservation;
    Menu? selectedMenu;
    private DinesaurUser? role;
    private string? url = "/";
    private sealed class OrderRow
    {
        public string Dish { get; set; } = "";
        public double Price { get; set; }
        public int Quantity { get; set; }
    }
    protected override async Task OnInitializedAsync()
    {
        selectedReservation = DbContext.Reservation.FirstOrDefault(x => x.ReservationID == id);
        selectedRestaurant = selectedReservation != null ? await DbContext.Restaurant.FirstOrDefaultAsync(r => r.RestaurantID == selectedReservation.RestaurantID) : null;
        selectedMenu = selectedRestaurant != null ? await DbContext.Menu.FirstOrDefaultAsync(m => m.RestaurantID == selectedRestaurant.RestaurantID) : null;
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NavigationManager.NavigateTo("/Account/Login");
            return;
        }

        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        Reservation.CustomerID = aspNetUserId;

        await using var db = await DbFactory.CreateDbContextAsync();

        var preOrder = await db.PreOrder.FirstOrDefaultAsync(p => p.ReservationID == id);

        if (preOrder == null)
            return;

        preOrderID = preOrder.PreOrderID;

        orderRows = await (
        from poi in db.PreOrderItem
        join f in db.Food on poi.FoodID equals f.FoodID
        where poi.PreOrderID == preOrderID.Value
        select new OrderRow
        {
            Dish = f.FoodName,
            Price = f.Cost,
            Quantity = poi.Quantity
        }
    ).ToListAsync();

        totalCost = preOrder.Cost;
        var email = await db.Users
        .Where(u => u.Id == aspNetUserId)
        .Select(u => u.Email)
        .SingleOrDefaultAsync();
        if (email != null)
        {
            var userrole = await UserManager.FindByEmailAsync(email);
            role = userrole;
           
        }
        if (await UserManager.IsInRoleAsync(role, "RestaurantStaff"))
        {
            url = "/Restaurant/Bookings";
        }
        else if (await UserManager.IsInRoleAsync(role, "User"))
        {
            url = "/MyBookings";

        }
        
    }

    private async Task SaveAndGoHome()
    {
        StateHasChanged();
        await using var db = await DbFactory.CreateDbContextAsync();
        await db.SaveChangesAsync();
        await JS.InvokeVoidAsync("alert", "Pre-Order is Confirmed!");
        NavigationManager.NavigateTo("#");


    }
    private async Task Back()
    {
        NavigationManager.NavigateTo("/Restaurant/Bookings");
    }
    private async Task EditPreOrdering()
    {

        NavigationManager.NavigateTo($"/Reservation/Create/PreOrder/{id}");

    }
    private async Task DeletePreOrder()
    {
        if (preOrderID == null)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();


        var preOrder = await db.PreOrder
            .FirstOrDefaultAsync(p => p.PreOrderID == preOrderID.Value);

        if (preOrder == null)
            return;


        var items = await db.PreOrderItem
            .Where(i => i.PreOrderID == preOrderID.Value)
            .ToListAsync();

        db.PreOrderItem.RemoveRange(items);


        db.PreOrder.Remove(preOrder);

        await db.SaveChangesAsync();


        orderRows.Clear();
        totalCost = 0;
        preOrderID = null;

        await JS.InvokeVoidAsync("alert", "Your Pre-Order Has Been Deleted");

        NavigationManager.NavigateTo("/MyBookings");

    }
    private bool CanEditPreOrder
    {
        get
        {
            if (selectedReservation?.Date == null)
                return false;


            var reservationDate = selectedReservation.Date.Value.Date;


            var cutoff = reservationDate.AddDays(-1);


            return DateTime.Now < cutoff;
        }
    }


        
    }


