@*Home Page For Dinesaur Restaurants*@


@page "/Restaurants/{id:int}"
@rendermode InteractiveServer
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext

<div style="display: flex; flex-direction:column">
<div id="start" style="background-color: dimgrey; height: 60vh; text-align: left; display: flex; flex-direction: column; padding-left: 50px;">
    <h1 style="padding-top: 100px; text-align: left">@selectedRestaurant?.RestaurantName</h1>
    <div style="display: flex; padding-top: 20px;">
        <div>
            <h3>Category: @selectedRestaurant?.Category</h3>
            
            <h3>Address: @selectedRestaurant?.Location</h3>
        </div>
        <div style="padding-left: 100px;">
                <h3>Hours: @selectedRestaurant?.OpeningHours.ToString("hh:mm tt") - @selectedRestaurant?.ClosingHours.ToString("hh:mm tt")</h3>
            <h3>Contact: @selectedRestaurant?.Contact</h3>
            <h3>Email: @selectedRestaurant?.Email</h3>
        </div>
        <div>
            <a style="padding: 20px; margin: 300px 50px; font-size: 25px; font-weight: bold; background-color: black; color: white; border-radius: 15px;" href="/Reservation/Create/@selectedRestaurant.RestaurantID"> Book Now</a>

        </div>
    </div>
</div>
<div style="margin: 20px 80px;">
    <h3>Top Selling Dishes</h3>
    <div style="display: flex; gap: 25px; justify-content: left; color:white; font-size: 25px;">
        @if (foods == null)
        {
            <p><em>No dishes available</em></p>
        }
        else
        {
            var random = new Random();
                @foreach (var food in foods)
                {
                    <div style="cursor:pointer;" @onclick="() => OpenPopup(food)">
                        <div style="z-index: 1000; position: relative;">
                            <div style="width: 250px; height: 250px; background-color: black; border-radius: 15px; overflow:hidden;">
                                @if (food.Image != null && food.Image.Count > 0)
                                {
                                    <img src="@food.Image[0]"
                                         style="height:100%; width:100%; object-fit:cover;"
                                         alt="@food.FoodName" />
                                }
                                else
                                {
                                    <div style="height:100%; display:flex; align-items:center; justify-content:center; color:#aaa;">
                                        No image
                                    </div>
                                }
                            </div>

                            <h4>@food.FoodName</h4>
                            <p>$@($"{food.Cost:F2}")</p>
                        </div>
                    </div>
                }

        }
    </div>
</div>
    <div style="margin: 20px 80px;">
        <div style="display: flex; gap: 15px; align-content: baseline"> 
            <h3>Reviews</h3>
            <InputSelect @bind-Value="ratingTab" style="width: 75px; background: #386641; height: 100%; color: yellow; font-weight: bold; border-radius: 10px; padding: 5px;">
                <option selected style="color: yellow; padding: 5px;" value="0">All</option>
                <option style="color: yellow; padding: 5px;" value="5">5 ★</option>
                <option style="color: yellow; padding: 5px;" value="4">4 ★</option>
                <option style="color: yellow; padding: 5px;" value="3">3 ★</option>
                <option style="color: yellow; padding: 5px;" value="2">2 ★</option>
                <option style="color: yellow; padding: 5px;" value="1">1 ★</option>
            </InputSelect>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; justify-content: left">
            @if (reviews == null)
            {
                <p><em>No Reviews Available</em></p>
            }
            else
            {
                if (ratingTab > 0)
                {
                    reviewsTab = reviews.Where(r => r.Rating == ratingTab).OrderByDescending(r => r.Date).ToList();
                    
                } else
                {
                    reviewsTab = reviews.OrderByDescending(r => r.Rating).ToList();
                }
                @foreach (var review in reviewsTab)
                {
                    using var context = DbFactory.CreateDbContext();
                    var user = context.DinesaurUser.FirstOrDefault(r => r.DinesaurUserID == review.CustomerID);
                    <a @onclick="()=>OpenReviewPopUp(review)">
                        <div style="z-index: 1000; position: relative; cursor: pointer;">
                            <div style="width: 500px; height: auto; background-color: #386641; border-radius: 15px; pointer-events: none; padding: 15px;">
                                <div style="display: display; flex-direction: column">
                                    <div style=" display: grid; grid-template-columns: 85% 1fr; align-items:baseline">
                                        <div style="display: flex; flex-direction: column; gap: 5px;">
                                            <h4 style="font-weight: bold; color: #88E788">@review.ReviewTitle</h4>
                                            <h6 style="font-weight: bold">@user.DinesaurUserName - @review.Date.ToString("dd MMMM yyyy")</h6>
                                        </div>
                                        <div>
                                            <h5 style="color:yellow; font-weight:bold; text-align: right">@review.Rating ★</h5>
                                        </div>
                                    </div>
                                    <div>
                                        @if (review.Description.Length > 50)
                                        {
                                            <p style="color: white; font-weight: normal">
                                                @(string.IsNullOrWhiteSpace(review.Description) ? "N/A" : review.Description.Substring(0, 50))...
                                            </p>
                                        }
                                        else
                                        {
                                            <p style="color: white; font-weight: normal">
                                                @(string.IsNullOrWhiteSpace(review.Description) ? "N/A" : review.Description)
                                            </p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>

                }
            }
            }
        </div>
    </div>
    @if (showPopup && popupFood != null)
    {
        <div style="position:fixed; inset:0; background:rgba(0,0,0,0.75);
                    display:flex; align-items:center; justify-content:center; z-index:9999;"
             @onclick="ClosePopup">

            <div style="width:700px; max-width:95vw; background:#111; color:white;
                        border-radius:18px; overflow:hidden;"
                 @onclick:stopPropagation="true">

                <div style="height:300px; background:black;">
                    @if (popupFood.Image != null && popupFood.Image.Count > 0)
                    {
                        <img src="@popupFood.Image[0]"
                             alt="@popupFood.FoodName"
                             style="width:100%; height:100%; object-fit:cover;" />
                    }
                    else
                    {
                        <div style="height:100%; display:flex; align-items:center; justify-content:center; color:#aaa;">
                            No image available
                        </div>
                    }
            </div>  

            <div style="padding:20px;">
                <div style="display:flex; justify-content:space-between; gap:20px;">
                    <div>
                        <h2 style="margin:0;">@popupFood.FoodName</h2>
                        <p style="margin:8px 0; color:#ccc;">
                            @(string.IsNullOrWhiteSpace(popupFood.Description)
                                                        ? "No description available."
                                                        : popupFood.Description)
                            </p>
                        </div>

                        <div style="text-align:right; min-width:150px;">
                            <p style="margin:0; font-size:18px;">
                                <b>@popupFood.Cost.ToString("C")</b>
                            </p>
                        </div>
                    </div>

                    <div style="text-align:right; margin-top:20px;">
                        <button class="btn btn-secondary" type="button" @onclick="ClosePopup">Close</button>
                    </div>
                </div>

            </div>
        </div>
    }

    @*Show Review Pop Up*@
    @if (reviewPopUp)
    {

        <div class="modal-backdrop" @onclick="CloseReviewPopUp">
            <div class="modal-card" @onclick:stopPropagation>
                <button class="close-btn" @onclick="CloseReviewPopUp">✕</button>
                <div style="display: flex; gap: 20px; align-items: baseline">
                    <h2 style="font-weight: bold; color: #88E788">@selectedReview.ReviewTitle</h2>
                    <div style="display: flex; gap: 5px; align-items: baseline">
                    @for (int i = 1; i <= selectedReview.Rating; i++)
                        {
                        <h5 style="color: yellow; font: bold">★</h5>
                        }
                    </div>
                    
                </div>

                <div style="display: flex; gap: 30px;">
                    <div style="display: flex; flex-direction:column">
                        <h6 style="font-weight: bold">Diner:</h6>
                        <h6 style="font-weight: bold">Posted On:</h6>
                    </div>
                    <div style="display: flex; flex-direction:column">
                        <h6> @selectedUser.DinesaurUserName </h6>
                        <h6>@selectedReview.Date.ToString("dd MMMM yyyy")</h6>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="reservation-detail">
                        <span class="reservation-label">Description:</span>
                    </div>
                    <p style="color: white; border-bottom: 1px solid; padding: 5px;">
                        @(string.IsNullOrWhiteSpace(selectedReview.Description) ? "N/A" : selectedReview.Description)
                    </p>
                </div>
                <div class="modal-buttons">
                    <a class="secondary-btn" @onclick="CloseReviewPopUp">
                        Back
                    </a>
                    <a class="danger-btn" @onclick="OpenReportPopUp">Report</a>
                </div>
            </div>
        </div>

    }

    @if (reportPopUp)
    {
        <div class="modal-backdrop" @onclick="CloseReportPopUp">

            <div class="modal-card" @onclick:stopPropagation>
                <button class="close-btn" @onclick="CloseReportPopUp">✕</button>
                <h2 style="color: #88E788">Report Review:</h2>
                <p style="color: white">Are you sure you want to report this review?</p>
                <div class="modal-buttons">
                    <button class="danger-btn" @onclick="ReportReview">Yes</button>
                    <button class="secondary-btn" @onclick="CloseReportPopUp">No</button>
                </div>
            </div>
        </div>

    }

    @if (reportConfirmationPopUp)
    {
        <div class="modal-backdrop" @onclick="CloseReportConfirmationPopUp">

            <div class="modal-card" @onclick:stopPropagation>
                <h2 style="color: #88E788">Thank You!</h2>
                <p style="color: white">Review has been reported, thank you for your feedback.</p>
                <div class="modal-buttons">
                    <button class="secondary-btn" @onclick="CloseReportConfirmationPopUp">Back</button>
                </div>
            </div>
        </div>

    }
</div>


@code {
    [Parameter]
    public int id { get; set; }

    Restaurant? selectedRestaurant;
    Review? selectedReview;
    Menu? selectedMenu;
    DinesaurUserModel? selectedUser;
    Reservation? selectedReservation;
    private List<Food> foods;
    private List<Review> reviews;
    private bool showPopup = false;
    private Food? popupFood;
    private int ratingTab = 0;
    private List<Review> reviewsTab = new();
    protected override async Task OnInitializedAsync()
    {
        selectedRestaurant = DbContext.Restaurant.FirstOrDefault(x => x.RestaurantID == id);
        selectedMenu = DbContext.Menu.FirstOrDefault(m => m.RestaurantID == selectedRestaurant.RestaurantID);
        if (selectedMenu == null)
        {
            reviews = new List<Review>();
            return;
        }
        foods = await DbContext.Food.Where(f => f.MenuID == selectedMenu.MenuID).ToListAsync();
        reviews = await DbContext.Review.Where(r => r.RestaurantID == selectedRestaurant.RestaurantID).ToListAsync();
    }
    private void OpenPopup(Food f)
    {
        popupFood = f;
        showPopup = true;
    }

    private void ClosePopup()
    {
        showPopup = false;
        popupFood = null;
    }

    public bool reviewPopUp = false;
    private void OpenReviewPopUp(Review review)
    {
        selectedReview = review;
        using var context = DbFactory.CreateDbContext();
        selectedUser = context.DinesaurUser.FirstOrDefault(r => r.DinesaurUserID == review.CustomerID);
        selectedReservation = DbContext.Reservation.FirstOrDefault(m => m.ReviewID == selectedReview.ReviewID);
        reviewPopUp = true;
    }

    private void CloseReviewPopUp()
    {
        reviewPopUp = false;
        selectedReview = null;
        selectedReservation = null;
        selectedUser = null;
    }

    public bool reportPopUp = false;
    private void OpenReportPopUp()
    {
        reportPopUp = true;
    }

    private void CloseReportPopUp()
    {
        reportPopUp = false;
    }

    private async Task ReportReview()
    {
        if (selectedReview != null)
        {
            selectedReview.Status = Review.ApprovalStatusReviews.Reported;
            DbContext.Review.Update(selectedReview);
            await DbContext.SaveChangesAsync();
        }
        CloseReviewPopUp();
        CloseReportPopUp();
        reportConfirmationPopUp = true;
    }

    public bool reportConfirmationPopUp = false;
    private void OpenReportConfirmationPopUp()
    {
        reportConfirmationPopUp = true;
    }

    private void CloseReportConfirmationPopUp()
    {
        reportConfirmationPopUp = false;
    }
}
    