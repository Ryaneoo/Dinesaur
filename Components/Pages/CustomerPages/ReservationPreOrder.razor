@*Pre-Order Food Items for Reservation*@


@page "/Reservation/Create/PreOrder/{id:int}"
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext

<div style="display: flex; flex-direction:column">
    <div style="background-color: dimgrey; height: auto; text-align: left; display: flex; flex-direction: column; padding: 10px 30px;">
        <h1 style="padding-top: 100px; text-align: left">Pre - Order</h1>
        <h2>Order your dishes now and enjoy your food when you arrive!</h2>

        <div style="background-color: black; display: grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; border-radius: 15px;  padding: 10px;">
@if (selectedMenu?.Catergories != null)
{
                <button style="background-color: grey; color:white ; border-radius: 5px; padding: 10px; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;font-weight:bold;"
                    @onclick="() => selectedCategory = null"> All</button>
            @foreach (var i in selectedMenu?.Catergories.Skip(1))
            {
                    
                    <button style="background-color: grey; color:white ; border-radius: 5px; padding: 10px; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;font-weight:bold;"
                    @onclick="() => SelectCategory(i)"> @i</button>
                }
            }
            else
            {
                
            }
        </div>
    </div>
    <div style="padding: 30px 30px; display:flex; flex-direction: column; gap: 10px; margin-top: 50px;">
        

        <div style=" display: grid; grid-template-columns:repeat(5, 1fr); gap: 30px; border-radius: 20px;  padding: 15px;">
            @if (food == null || food.Count == 0)
            {
                <div style="grid-column: 1 / -1; color:white;">
                    No food items found for this reservation.
                </div>
            }
            else{
                @foreach (var f in food.Where(f =>
                            selectedCategory == null || f.Category == selectedCategory))
                {
                    <div style="background-color: black; color: white; border-radius: 20px; padding: 10px; height: 40vh; display: flex; flex-direction: column; gap: 5px; cursor:pointer;"
                         @onclick="() => OpenPopup(f)">

                           <img src="@f.Image[0]"
         style="height: 75%; width: 100%; object-fit: cover; border-radius: 10px;"
         alt="@f.FoodName" />

                    <div style="display: grid; grid-template-columns: 70% 1fr; padding: 10px 10px; gap: 10px"> 
                        <h5> @GetFoodName(f)</h5>
                        <h5> @GetFoodPrice(f).ToString("C")</h5>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(30px, 1fr)); background-color: grey; border-radius: 10px; text-align:center; ">
                            <a style="background-color:red; height: 100%; border-radius: 10px 0px 0px 10px; padding-top: 5px; font-weight: bold; z-index: 1000; cursor: pointer;"
                               @onclick="() => Dec(f.FoodID)"
                               @onclick:stopPropagation="true">-</a>
                        <h5 style="background-color: white; color: black; height: 100%; padding-top: 5px; font-weight: bold">@GetCount(f.FoodID)</h5>
                            <a style="background-color: green; height: 100%; border-radius: 0px 10px 10px 0px; padding-top: 7px; font-weight: bold; z-index: 1000; cursor: pointer;"
                               @onclick="() => Inc(f.FoodID)"
                               @onclick:stopPropagation="true">+</a>
                    </div>
                    
                </div>
                }
            }

        </div>
    </div>
    <a href="#"
       style="
       display:block;
       width: 200px;
       text-align:center;
       padding:12px 0;
       background-color:green;
       color:white;
       font-weight:bold;
       border-radius:10px;
       cursor:pointer;
       text-decoration:none;
       margin:100px auto;"
       @onclick="() => SaveAndGoToOrderList(id)"
       @onclick:preventDefault="true">
        Order List
    </a>

    @if (showPopup && popupFood != null)
    {
        <div style="
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;"
             @onclick="ClosePopup">

            <div style="
                width: 700px;
                max-width: 95vw;
                background: #111;
                color: white;
                border-radius: 18px;
                overflow: hidden;"
                 @onclick:stopPropagation="true">

                <div style="height: 300px; background: black;">
                    @if (popupFood.Image != null && popupFood.Image.Count > 0)
                    {
                        <img src="@popupFood.Image[0]"
                             alt="@popupFood.FoodName"
                             style="width:100%; height:100%; object-fit:cover;" />
                    }
                    else
                    {
                        <div style="height:100%; display:flex; align-items:center; justify-content:center; color:#aaa;">
                            No image available
                        </div>
                    }
            </div>

            <div style="padding: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap: 20px;">
                    <div>
                        <h2 style="margin:0;">@popupFood.FoodName</h2>

                        <p style="margin: 8px 0; color:#ccc;">
                            @(string.IsNullOrWhiteSpace(popupFood.Description)
                                                        ? "No description available."
                                                        : popupFood.Description)
                            </p>
                        </div>

                        <div style="text-align:right; min-width:150px;">
                            <p style="margin:0; font-size: 18px;">
                                <b>@popupFood.Cost.ToString("C")</b>
                            </p>
                        </div>
                    </div>

                    <div style="text-align:right; margin-top: 20px;">
                        <button class="btn btn-secondary" @onclick="ClosePopup">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }



   


</div>




@code {


    [Parameter]
    public int id { get; set; }
    private int preOrderID;


    public DateTime Date { get; set; }
    public TimeSpan Time { get; set; }
    public Reservation Reservation { get; set; } = new();
    Restaurant? selectedRestaurant;
    Reservation? selectedReservation;
    Menu? selectedMenu;
    private string? selectedCategory;
    private bool showPopup = false;
    private Food? popupFood;
    

    private List<Food> food = new();
    private readonly Dictionary<int, int> itemCounts = new();


    protected override async Task OnInitializedAsync()
    {
        selectedReservation = DbContext.Reservation.FirstOrDefault(x => x.ReservationID == id);
        selectedRestaurant = selectedReservation != null ? await DbContext.Restaurant.FirstOrDefaultAsync(r => r.RestaurantID == selectedReservation.RestaurantID) : null;
        selectedMenu = selectedRestaurant != null ? await DbContext.Menu.FirstOrDefaultAsync(m => m.RestaurantID == selectedRestaurant.RestaurantID) : null;
        var preOrder = await DbContext.PreOrder.FirstOrDefaultAsync(p => p.ReservationID == id);
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NavigationManager.NavigateTo("/Account/Login");
            return;
        }

        if (selectedReservation == null)
            return;

        if (preOrder == null)
        {
            preOrder = new PreOrder
            {
                ReservationID = id,
                Cost = 0,
                MenuID = selectedMenu?.MenuID ?? 0
            };

            DbContext.PreOrder.Add(preOrder);
            await DbContext.SaveChangesAsync();
        }


        preOrderID = preOrder.PreOrderID;


        if (selectedMenu != null)
        {
            food = await DbContext.Food
                .Where(f => f.MenuID == selectedMenu.MenuID)
                .ToListAsync();
        }
        else
        {
            food = new List<Food>(); // or leave empty
        }


        var existingItems = await DbContext.PreOrderItem
           .Where(i => i.PreOrderID == preOrderID)
           .ToListAsync();

        var existingItemsCat = selectedMenu?.Catergories;

        


        foreach (var it in existingItems)
            itemCounts[it.FoodID] = it.Quantity;

        

        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        Reservation.CustomerID = aspNetUserId;

        
    }

    private async Task SaveAndGoToOrderList(int id)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var items = await db.PreOrderItem
            .Where(i => i.PreOrderID == preOrderID)
            .ToListAsync();

        double total = 0;
        total = await (
    from poi in db.PreOrderItem
    join f in db.Food on poi.FoodID equals f.FoodID
    where poi.PreOrderID == preOrderID
    select f.Cost * poi.Quantity
).SumAsync();

        var preOrder = await db.PreOrder.FirstAsync(p => p.PreOrderID == preOrderID);
        preOrder.Cost = total;

        await db.SaveChangesAsync();

        // ✅ now navigate
        NavigationManager.NavigateTo($"/Reservation/OrderList/{id}");
    }


    // Quantity helpers
    private int GetCount(int foodId) => itemCounts.TryGetValue(foodId, out var v) ? v : 0;

    private async Task Inc(int foodId)
    {
        itemCounts[foodId] = GetCount(foodId) + 1;
        await AddtoPreOrder(foodId, GetCount(foodId));
    }

    private async Task Dec(int foodId)
    {
        itemCounts[foodId] = Math.Max(GetCount(foodId) - 1, 0);
        await AddtoPreOrder(foodId, GetCount(foodId));
    }

    private string GetFoodName(Food f) => f.FoodName;       
    private decimal GetFoodPrice(Food f) => (decimal)f.Cost;
    
    /*private int GetCountCat(int Categories) =>*/

    async Task AddtoPreOrder(int foodId, int qty)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var existing = await db.PreOrderItem.FirstOrDefaultAsync(p =>
            p.PreOrderID == preOrderID &&
            p.FoodID == foodId);

        if (qty <= 0)
        {
            if (existing != null)
            {
                db.PreOrderItem.Remove(existing);   // or existing.Quantity = 0;
                await db.SaveChangesAsync();
            }
            return;
        }

        if (existing == null)
        {
            db.PreOrderItem.Add(new PreOrderItem
            {
                PreOrderID = preOrderID,
                FoodID = foodId,
                Quantity = qty
            });
        }
        else
        {
            existing.Quantity = qty;
        }

        await db.SaveChangesAsync();
    }

    private void SelectCategory(string category)
    {
        selectedCategory = category;
    }

    private void OpenPopup(Food f)
    {
        popupFood = f;
        showPopup = true;
    }

    private void ClosePopup()
    {
        showPopup = false;
        popupFood = null;
    }



        



    }

  
    

