@* Admin Home Page *@
@page "/Admin/Home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext
@inject UserManager<Dinesaur.Data.DinesaurUser> UserManager
@inject IJSRuntime JS
@rendermode InteractiveServer

<AuthorizeView Roles="Administrator">
    <Authorized>
        <!-- MAIN PANEL -->
        <div style="
            width: 100%;
            color: white;
            padding: 50px;
            display:grid;
            grid-template-columns:1fr auto;
            align-items: start;">
            
           
            <!-- Display Name -->
            <div style="display: flex; flex-direction:column; gap:40px;">
                <div>
                    <h1 style="text-align: left">Welcome,</h1>
                    <h1 style="text-align: left">@displayName!</h1>
                </div>

                <!--Show The Overview of users, restaurants and reviews for admin-->
                <div style="
                    color:white;
                    font-size:60px;
                    line-height:1.7;
                    max-width:800px;">
                    There are “@NewUsersCount” New Users today<br/>
                    There are “@pendingRestaurants” New Restaurants for review<br />
                    There are “@pendingReviews” New Reviews for review
                    
                </div>
            </div>

            <!--Charts to visualise traffic on the site-->
            <div style="width:500px;height:400px;margin-left:auto;margin-top:30px;">
                <h3 style="font-size:35px;">New Users (Last 7 Days)</h3>
                <canvas id="newUsersChart"></canvas>
                <h3 style="font-size:35px;">New Restaurants (Last 7 Days)</h3>
                <canvas id="restaurantsChart"></canvas>
            </div>

           
        </div>
    </Authorized>

    <NotAuthorized>
        <div style="
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        height:95vh;
        color:white;
        text-align:center;">

            <h1 style="font-size:140px;">Access Denied</h1>
            <p style="font-size:90px;">You must be an admin to view this page</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {

    // Fields / State

    private string? displayName;
    private int NewUsersCount;
    private DateTime? sinceUtc;
    private int pendingRestaurants;
    private int pendingReviews;
    private string[] newUserLabels = Array.Empty<string>();
    private int[] newUserCounts = Array.Empty<int>();
    private string[] restaurantLabels = Array.Empty<string>();
    private int[] restaurantCounts = Array.Empty<int>();
    private bool _chartRendered;

    protected override async Task OnInitializedAsync()
    {

        var user = (await Auth.GetAuthenticationStateAsync()).User;
     
        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await using var db = await DbFactory.CreateDbContextAsync();
        var identityUser = await db.Users
            .Where(u => u.Id == aspNetUserId)
            .Select(u => u.Name)
            .SingleOrDefaultAsync();

        displayName = identityUser ?? user.Identity?.Name;

        
        var startOfTodayUtc = DateTime.UtcNow.Date;

        if (sinceUtc != null)
        {
            NewUsersCount = await db.Users
                .CountAsync(u => u.CreatedAtUtc > startOfTodayUtc);
        }
        else
        {
            NewUsersCount = 0;
        }

        pendingRestaurants = await db.Restaurant
            .CountAsync(r => r.Status == Restaurant.ApprovalStatus.Pending);
        pendingReviews = await db.Review
            .CountAsync(rev => rev.Status == Review.ApprovalStatusReviews.Published);


        var startUtc = DateTime.UtcNow.Date.AddDays(-6);     // 7 days incl today (UTC dates)
        var endUtcExclusive = DateTime.UtcNow.Date.AddDays(1);

        var daily = await db.Users
            .Where(u => u.CreatedAtUtc >= startUtc && u.CreatedAtUtc < endUtcExclusive)
            .GroupBy(u => u.CreatedAtUtc.Date)
            .Select(g => new { Day = g.Key, Count = g.Count() })
            .ToListAsync();


        var map = daily.ToDictionary(x => x.Day, x => x.Count);

        newUserLabels = Enumerable.Range(0, 7)
            .Select(i => startUtc.AddDays(i).ToString("dd MMM"))
            .ToArray();

        newUserCounts = Enumerable.Range(0, 7)
            .Select(i =>
            {
                var day = startUtc.AddDays(i);
                return map.TryGetValue(day, out var c) ? c : 0;
            })
            .ToArray();

        await InvokeAsync(StateHasChanged);

        var dailyRestaurants = await db.Restaurant
    .Where(r => r.CreatedAtUtc >= startUtc && r.CreatedAtUtc < endUtcExclusive)
    .GroupBy(r => r.CreatedAtUtc.Date)
    .Select(g => new { Day = g.Key, Count = g.Count() })
    .ToListAsync();

        var restaurantMap = dailyRestaurants.ToDictionary(x => x.Day, x => x.Count);

        restaurantLabels = Enumerable.Range(0, 7)
            .Select(i => startUtc.AddDays(i).ToString("dd MMM"))
            .ToArray();

        restaurantCounts = Enumerable.Range(0, 7)
            .Select(i =>
            {
                var day = startUtc.AddDays(i);
                return restaurantMap.TryGetValue(day, out var c) ? c : 0;
            })
            .ToArray();

        await InvokeAsync(StateHasChanged);
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_chartRendered) return;

        // only run when canvas is actually in the DOM + data is ready
        if (newUserLabels.Length == 7 && newUserCounts.Length == 7)
        {
            _chartRendered = true;
            await JS.InvokeVoidAsync("renderNewUsersChart", newUserLabels, newUserCounts);
            await JS.InvokeVoidAsync("renderRestaurantsChart", restaurantLabels, restaurantCounts);
        }
}
}


