@*Admin Restaurant Approval Page*@
@page "/Admin/Reviews/manage"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext
@inject UserManager<Dinesaur.Data.DinesaurUser> UserManager

<AuthorizeView Roles="Administrator">
    <Authorized>
        <!-- MAIN PANEL -->
        <div style="
            width: 100%;
            color: white;
            padding: 50px;
            align-items: center;">

            <div style="display: flex; gap: 25px; height: 400px; align-items: center; justify-content: left">
                <div>
                    <h1 style="text-align: left">Welcome,</h1>
                    <h1 style="text-align: left">@displayName!</h1>
                </div>
            </div>
            <div style="margin-top:40px;">
                <h2 style="font-size:70px;">Pending Reviews</h2>

                @if (isLoading)
                {
                    <p style="font-size:50px;">Loading...</p>
                }
                else if (pendingReviews.Count == 0)
                {
                    <p style="font-size:50px;">No reviews awaiting approval.</p>
                }
                else
                {
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead>
                            <tr style="border-bottom:2px solid #444; font-size:35px;">
                                <th style="padding:14px; text-align:left;">Review Title</th>
                                <th style="padding:14px; text-align:left;">Description</th>
                                <th style="padding:14px; text-align:left;">Location</th>
                                <th style="padding:14px; text-align:left;">Rating</th>
                                <th style="padding:14px; text-align:left;">Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var r in pendingReviews)
                            {
                                <tr style="border-bottom:1px solid #333; font-size:32px;">
                                    <td style="padding:14px;">@r.ReviewTitle</td>
                                    <td style="padding:14px;">@r.Description</td>
                                    <td style="padding:14px;">@r.Location</td>
                                    <td style="padding:14px;">@r.Rating ⭐</td>


                                    <td style="padding:20px;">
                                        <div style=" display:flex; gap:30px">
                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer; margin-right:10px;"
                                                    disabled="@busyIds.Contains(r.ReviewID)"
                                                    @onclick="() => SetStatusAsync(r.ReviewID, Review.ApprovalStatusReviews.Approved)">
                                                Approve
                                        </button>

                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer;"
                                                    disabled="@busyIds.Contains(r.ReviewID)"
                                                    @onclick="() => SetStatusAsync(r.ReviewID, Review.ApprovalStatusReviews.Rejected)">
                                                Reject
                                        </button>

                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer;"
                                                @onclick="() => MoreDetails(r.ReviewID)">
                                            More Details
                                        </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }

                @if (!string.IsNullOrWhiteSpace(message))
                {
                    <p style="margin-top:18px; font-size:28px;">@message</p>
                }
            </div>
        </div>
    </Authorized>

    <NotAuthorized>
        <div style="
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        height:95vh;
        color:white;
        text-align:center;">

            <h1 style="font-size:140px;">Access Denied</h1>
            <p style="font-size:90px;">You must be an admin to view this page</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string? displayName;
    private bool isLoading = true;
    private string? message;

    private List<Review> pendingReviews = new();
    private HashSet<int> busyIds = new();

    protected override async Task OnInitializedAsync()
    {
        var user = (await Auth.GetAuthenticationStateAsync()).User;
        if (!user.Identity?.IsAuthenticated ?? true) return;

        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await using var db = await DbFactory.CreateDbContextAsync();
        var identityUser = await db.Users
            .Where(u => u.Id == aspNetUserId)
            .Select(u => u.Name)
            .SingleOrDefaultAsync();

        displayName = identityUser ?? user.Identity?.Name;

        await LoadPendingReviewsAsync();

    }
    private async Task LoadPendingReviewsAsync()
    {
        isLoading = true;
        message = null;

        await using var db = await DbFactory.CreateDbContextAsync();

        pendingReviews = await db.Review
            .Where(r => r.Status == Review.ApprovalStatusReviews.Pending)
            .OrderByDescending(r => r.ReviewID)
            .ToListAsync();

        isLoading = false;
    }


    private async Task SetStatusAsync(int reviewId, Review.ApprovalStatusReviews newStatus)
    {
        busyIds.Add(reviewId);
        message = null;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            var review = await db.Review
                .FirstOrDefaultAsync(r => r.ReviewID == reviewId);

            if (review is null)
            {
                message = "Review not found.";
                await LoadPendingReviewsAsync();
                return;
            }

            review.Status = newStatus;
            await db.SaveChangesAsync();

            pendingReviews.RemoveAll(r => r.ReviewID == reviewId);

            message = newStatus == Review.ApprovalStatusReviews.Approved
                ? "Review approved."
                : "Review rejected.";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
        finally
        {
            busyIds.Remove(reviewId);
            await InvokeAsync(StateHasChanged);
        }
    }

    private void MoreDetails(int reviewId)
    {
        NavigationManager.NavigateTo($"/Admin/Review/Details/{reviewId}");
    }
}

