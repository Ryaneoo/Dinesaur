@*Admin Restaurant Approval Page*@
@page "/Admin/restaurant/manage"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Dinesaur.Domain
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject Dinesaur.Data.DinesaurContext DbContext
@inject UserManager<Dinesaur.Data.DinesaurUser> UserManager

<AuthorizeView Roles="Administrator">
    <Authorized>
        <!-- MAIN PANEL -->
        <div style="
            width: 100%;
            color: white;
            padding: 50px;
            align-items: center;">

            <div style="display: flex; gap: 25px; height: 400px; align-items: center; justify-content: left">
                <div>
                    <h1 style="text-align: left">Welcome,</h1>
                    <h1 style="text-align: left">@displayName!</h1>
                </div>
            </div>
            <div style="margin-top:40px;">
                <h2 style="font-size:70px;">Pending Restaurants</h2>

                @if (isLoading)
                {
                    <p style="font-size:50px;">Loading...</p>
                }
                else if (pendingRestaurants.Count == 0)
                {
                    <p style="font-size:50px;">No restaurants awaiting approval.</p>
                }
                else
                {
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead>
                            <tr style="border-bottom:2px solid #444; font-size:35px;">
                                <th style="padding:14px; text-align:left;">Name</th>
                                <th style="padding:14px; text-align:left;">Location</th>
                                <th style="padding:14px; text-align:left;">Category</th>
                                <th style="padding:14px; text-align:left;">Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var r in pendingRestaurants)
                            {
                                <tr style="border-bottom:1px solid #333; font-size:32px;">
                                    <td style="padding:14px;">@r.RestaurantName</td>
                                    <td style="padding:14px;">@r.Location</td>
                                    <td style="padding:14px;">@r.Category</td>

                                    <td style="padding:20px;">
                                        <div style=" display:flex; gap:30px">
                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer; margin-right:10px;"
                                                disabled="@busyIds.Contains(r.RestaurantID)"
                                                @onclick="() => SetStatusAsync(r.RestaurantID, Restaurant.ApprovalStatus.Approved)">
                                            Approve
                                        </button>

                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer;"
                                                disabled="@busyIds.Contains(r.RestaurantID)"
                                                @onclick="() => SetStatusAsync(r.RestaurantID, Restaurant.ApprovalStatus.Rejected)">
                                            Reject
                                        </button>

                                        <button style="padding:12px 16px; font-size:25px; cursor:pointer;"
                                                @onclick="() => MoreDetails(r.RestaurantID)">
                                            More Details
                                        </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }

                @if (!string.IsNullOrWhiteSpace(message))
                {
                    <p style="margin-top:18px; font-size:28px;">@message</p>
                }
            </div>
        </div>
    </Authorized>

    <NotAuthorized>
        <div style="
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        height:95vh;
        color:white;
        text-align:center;">

            <h1 style="font-size:140px;">Access Denied</h1>
            <p style="font-size:90px;">You must be an admin to view this page</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string? displayName;
    private bool isLoading = true;
    private string? message;

    private List<Restaurant> pendingRestaurants = new();
    private HashSet<int> busyIds = new();

    protected override async Task OnInitializedAsync()
    {
        var user = (await Auth.GetAuthenticationStateAsync()).User;
        if (!user.Identity?.IsAuthenticated ?? true) return;

        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await using var db = await DbFactory.CreateDbContextAsync();
        var identityUser = await db.Users
            .Where(u => u.Id == aspNetUserId)
            .Select(u => u.Name)
            .SingleOrDefaultAsync();

        displayName = identityUser ?? user.Identity?.Name;

        await LoadPendingRestaurantsAsync();

    }
    private async Task LoadPendingRestaurantsAsync()
    {
        isLoading = true;
        message = null;

        await using var db = await DbFactory.CreateDbContextAsync();

        pendingRestaurants = await db.Restaurant
            .Where(r => r.Status == Restaurant.ApprovalStatus.Pending)
            .OrderByDescending(r => r.RestaurantID)
            .ToListAsync();

        isLoading = false;
    }


    private async Task SetStatusAsync(int restaurantId, Restaurant.ApprovalStatus newStatus)
    {
        busyIds.Add(restaurantId);
        message = null;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            var restaurant = await db.Restaurant
                .FirstOrDefaultAsync(r => r.RestaurantID == restaurantId);

            if (restaurant is null)
            {
                message = "Restaurant not found (it may have been processed already).";
                await LoadPendingRestaurantsAsync();
                return;
            }

            restaurant.Status = newStatus;
            await db.SaveChangesAsync();


            // Remove from UI list immediately
            pendingRestaurants.RemoveAll(r => r.RestaurantID == restaurantId);

            message = newStatus == Restaurant.ApprovalStatus.Approved
                ? "Restaurant approved."
                : "Restaurant rejected.";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
        finally
        {
            busyIds.Remove(restaurantId);
        }
    }
    private void MoreDetails(int restaurantId)
    {
        
        NavigationManager.NavigateTo("/Admin/Restaurant/Details/{restaurantId}");
    }
}
}
