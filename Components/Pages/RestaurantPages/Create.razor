@page "/restaurants/create"
@using Microsoft.EntityFrameworkCore
@using Dinesaur.Domain
@using System.Security.Claims
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider authenticationStateProvider
@rendermode InteractiveServer
@inject IJSRuntime JS
<PageTitle>Create</PageTitle>

@* Here they create the restaurant and add all details of it  *@

    <div style="
        max-width: 1100px;
        margin: 0 auto;
    ">
        <div style="text-align:center; color:white;">
            <h1 style="margin-top:40px;">Create Restaurant</h1>
            <p style="margin: 10px 0 30px 0; color:#cfcfcf;">
                Fill in the details below. You can upload your logo on the right.
            </p>
        </div>

        <EditForm method="post" Model="Restaurant" OnValidSubmit="AddRestaurant" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div style="
                display:grid;
                grid-template-columns: 1.2fr 0.8fr;
                gap: 24px;
                align-items:start;
            ">

                <!-- LEFT: Form Card -->
                <div style="
                    background:#111;
                    border-radius: 18px;
                    padding: 22px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.35);
                ">
                    <div class="mb-3">
                        <label for="restaurantname" class="form-label" style="color:white;">Restaurant Name</label>
                        <InputText id="restaurantname" @bind-Value="Restaurant.RestaurantName" class="form-control" />
                        <ValidationMessage For="() => Restaurant.RestaurantName" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="location" class="form-label" style="color:white;">Exact Location / Address</label>
                        <InputText id="location" @bind-Value="Restaurant.Location" class="form-control" />
                        <ValidationMessage For="() => Restaurant.Location" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="itemcategory" class="form-label" style="color:white;">Category</label>
                        <InputSelect id="itemcategory" @bind-Value="Restaurant.Category" class="form-select">
                            @foreach (string category in Categories)
                            {
                                <option value="@category">@category</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Restaurant.Category" class="text-danger" />
                    </div>

                    <div class="mb-3" hidden>
                        <label for="adminid" class="form-label">AdminID</label>
                        <InputNumber id="adminid" @bind-Value="Restaurant.AdminID" class="form-control" />
                        <ValidationMessage For="() => Restaurant.AdminID" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="contact" class="form-label" style="color:white;">Contact</label>
                        <InputNumber id="contact" @bind-Value="Restaurant.Contact" class="form-control" />
                        <ValidationMessage For="() => Restaurant.Contact" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label" style="color:white;">Email</label>
                        <InputText id="email" @bind-Value="Restaurant.Email" class="form-control" />
                        <ValidationMessage For="() => Restaurant.Email" class="text-danger" />
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="mb-3">
                            <label for="openinghours" class="form-label" style="color:white;">Opening Hour</label>
                            <InputDate @bind-value="Restaurant.OpeningHours"
                                       Type="InputDateType.Time"
                                       class="form-control"
                                       step="1800" />
                            <ValidationMessage For="() => Restaurant.OpeningHours" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label for="closinghours" class="form-label" style="color:white;">Closing Hour</label>
                            <InputDate @bind-value="Restaurant.ClosingHours"
                                       Type="InputDateType.Time"
                                       class="form-control"
                                       step="1800" />
                            <ValidationMessage For="() => Restaurant.ClosingHours" class="text-danger" />
                        </div>
                    </div>

             
                    <div style="
                        margin-top: 14px;
                        padding: 14px 14px;
                        background: rgba(255,255,255,0.06);
                        border: 1px solid rgba(255,255,255,0.10);
                        border-radius: 14px;
                        color:#ddd;
                        font-size: 14px;
                        line-height: 1.5;
                    ">
                        <b style="color:white;">Note:</b>
                        Your restaurant will be checked by admins and may be removed if deemed inappropriate.
                        By creating a restaurant, you agree to the site's terms and conditions.
                    </div>

                    <div style="display:flex; justify-content:flex-end; margin-top: 18px;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 26px; font-weight:600;">
                            Create
                        </button>
                    </div>
                </div>

               
                <div style="
                    background:#111;
                    border-radius: 18px;
                    padding: 22px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.35);
                ">
                    <h4 style="color:white; margin:0 0 12px 0;">Logo</h4>
                    <p style="color:#cfcfcf; margin: 0 0 14px 0; font-size: 14px;">
                        Upload a square image for best results. (Max 5MB)
                    </p>

                    <label for="image" class="form-label" style="color:white;">Upload Logo</label>
                    <InputFile id="image" OnChange="@LoadFiles" class="form-control" />

                    @if (FileErrors.Any())
                    {
                        <div class="alert alert-danger mt-3" role="alert">
                            <b>Errors in Uploading Logo:</b>
                            <ul style="margin: 8px 0 0 0;">
                                @foreach (var error in FileErrors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </div>
                    }

                    @if (Restaurant.Logo.Any())
                    {
                        <div style="
                                margin-top: 16px;
                                border-radius: 16px;
                                overflow:hidden;
                                border: 1px solid rgba(255,255,255,0.12);
                                background:#000;
                            ">
                            <img src="@Restaurant.Logo.FirstOrDefault()"
                                 style="width:100%; height: 280px; object-fit: cover;"
                                 alt="Uploaded Logo" />
                        </div>
                    }
                    else
                    {
                        <div style="
                                margin-top: 16px;
                                height: 280px;
                                border-radius: 16px;
                                border: 1px dashed rgba(255,255,255,0.25);
                                display:flex;
                                align-items:center;
                                justify-content:center;
                                color:#aaa;
                                text-align:center;
                                padding: 14px;
                            ">
                            No logo uploaded yet.
                        </div>
                    }
                </div>

            </div>
        </EditForm>
    </div>

<script>
    function showAlert() {
        alert("Image uploaded is not allowed pick another");
    }
</script>
@code {
    [SupplyParameterFromForm]
    private Restaurant Restaurant { get; set; } = new();
    private const int maxLogoFileSize = 5000000;
    private List<string> FileErrors = new List<string>();
    private async Task LoadFiles(InputFileChangeEventArgs e) //convert image (restaurant logo) uploaded to string and then add to database and then display
    {
        FileErrors.Clear();
        var files = e.GetMultipleFiles();
        var Logo = files.FirstOrDefault();
        if (Logo.Size > maxLogoFileSize)
        {
            FileErrors.Add($"File {Logo.Name} exceeds the maximum size of {maxLogoFileSize} bytes.");

        }

        if (!Logo.ContentType.StartsWith("image/"))
        {
            FileErrors.Add($"File {Logo.Name} is not a supported image format.");
        }
        using (var ms = new MemoryStream())
        {
            await Logo.OpenReadStream(maxLogoFileSize).CopyToAsync(ms);
            var fileBytes = ms.ToArray();
            String base64String = Convert.ToBase64String(fileBytes);
            string imageUri = $"data:{Logo.ContentType};base64,{base64String}";
            if (Restaurant.Logo.Count() > 0)
            {
                Restaurant.Logo.Clear();
            }
            Restaurant.Logo.Add(imageUri);
        }
        StateHasChanged();
    }
    private async Task AddRestaurant() //if image not allowed prevent creation
    {
        
        if (FileErrors.Any())
        {
            await JS.InvokeVoidAsync("showAlert");
        }
        else
        {
            Restaurant.RestaurantOwnerID = Id;
            Restaurant.AdminID = 1;
            using var context = DbFactory.CreateDbContext();
            context.Restaurant.Add(Restaurant);
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/RestaurantStaff/Home");
        }
    }
    private List<String> Categories = new List<String> //default categories of restaurant to fall in
    {
         "",
         "Western",
         "Fine Dining",
         "Dessert",
         "Vegetarian",
         "HotPot",
         "Others",
    };
    private string Id = "System";
    protected override async Task OnInitializedAsync() //get user id so when creation occurs the restaurant owner id is auto assigned
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null)
        {
            Id = userIdClaim.Value;
        }
    }
}
