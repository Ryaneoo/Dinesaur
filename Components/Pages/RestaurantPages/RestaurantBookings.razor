@*Users View Their Bookings*@

@*Page Link*@
@page "/Restaurant/Bookings" 

@*Imports*@
@using Dinesaur.Domain
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory

@*Container*@
<div style="display: flex; flex-direction:column">
    @* If try to access without a restaurant, will be told to create one first *@
    @if(hasRestaurant == false) 
    {
        <container style="text-align:center;">
        <h1 style="margin-top:40px;"> No Restaurant</h1>
        <a href="/restaurants/create" class="btn-primary" style="padding: 15px 32px;">Create Restaurant</a>
        </container>
    }
    else{
    @*Banner of booking states*@
    <div style="background-color: black; height: auto; text-align: left; display: flex; flex-direction: column; padding: 30px; background-color: rgb(0,0,0,60%)">
        <h1 style="margin-top: 100px; margin-bottom: 20px; text-align: left">@SelectedRestaurant.RestaurantName Bookings</h1>
        <div style="background-color: white; display: grid; grid-template-columns:repeat(auto-fit, minmax(10px, 1fr)); gap: 10px; border-radius: 10px;  padding: 5px;">
            <a style="background-color: #386641;
                        color:white ; 
                        border-radius: 5px; 
                        padding: 10px; 
                        font-weight:bold;
                        text-align: center"
                @onclick="@(() => GetBookings(1))">
            NEW
            </a>
            <a style="background-color: #24462C;
                        color:white ;
                        border-radius: 5px;
                        padding: 10px;
                        font-weight:bold;
                        text-align: center"
               @onclick="@(() => GetBookings(2))">CONFIRMED
            </a>
            <a style="background-color: darkorange;
                        color:black ;
                        border-radius: 5px;
                        padding: 10px;
                        font-weight:bold;
                        text-align: center"
                    @onclick="@(()=>GetBookings(3))">ONGOING
            </a>
            <a style="background-color: darkgreen;
                        color:white ;
                        border-radius: 5px;
                        padding: 10px;
                        font-weight:bold;
                        text-align: center"
               @onclick="@(() => GetBookings(4))">
                COMPLETED
            </a>
            <a style="background-color: darkred;
                        color:white ;
                        border-radius: 5px;
                        padding: 10px;
                        font-weight:bold;
                        text-align: center"
               @onclick="@(() => GetBookings(5))">
                CANCELLED
            </a>
        </div>
    </div>

    @*Bookings Displayed Here*@
    <div style="display: flex; gap: 25px; flex-direction: column; padding: 50px;">
        @if (BookingTab.Count == 0)
        {
            <h2><em>No Bookings</em></h2>
            <AuthorizeView Roles="User" Context="userAuth">
                <Authorized Context="userAuth">
                    @if (userAuth.User.IsInRole("RestaurantStaff"))
                    {
                        
                    }

                    else if (userAuth.User.IsInRole("User"))
                    {
                        <a style="padding: 20px; font-size: 25px; font-weight: bold; background-color: black; color: white; border-radius: 15px;" href="/User/Home"> Find Restaurants</a>
                    }

                </Authorized>
            </AuthorizeView>
            
        }
        else
        {

            @*Display Reservations Upcoming*@
            <h2 style="font-weight: bold"> @tabHeader Bookings</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                @foreach (var booking in BookingTab)
                {
                    using var context = DbFactory.CreateDbContext();
                    var user = context.DinesaurUser.FirstOrDefault(r => r.DinesaurUserID == booking.CustomerID);
                    @*Pull Restaurant Info*@
                    <a @onclick="() => OpenDetails(booking)">
                        <div style="z-index: 1000; position: relative; cursor: pointer;">
                            <div style="width: 100%; height: auto; background-color: #386641; border-radius: 15px; pointer-events: none; padding: 20px;">
                                <div style="display: grid; grid-template-columns: 70% 1fr;">
                                    <div>
                                        <h4 style="font-weight: bold; color: #88E788">@user.DinesaurUserName</h4>
                                        <p style="color:white">
                                            @booking.Date.Value.ToString("dd MMMM") - @booking.Time.Value.ToString("h:mm tt")<br />
                                            @booking.Pax PAX
                                        </p>
                                    </div>
                                    <div style="display: flex; height: 100%; justify-content: center;">
                                        <a style="width: 100%; height: 100%; padding: 10px; font-size: 20px; font-weight: bold; background-color: #88E788; color: black; border-radius: 15px; text-align: center; align-content: center" @onclick="() => OpenDetails(booking)">View</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                }
            </div>
        }
    </div>

          

    }

    @*Show Details Pop Up*@
    @if (ShowPopUp && SelectedReservation != null)
    {
        <div class="modal-backdrop" @onclick="CloseDetails">

            <div class="modal-card" @onclick:stopPropagation>
                <button class="close-btn" @onclick="CloseDetails">✕</button>

                <h2 style="color: #88E788">@SelectedUser.DinesaurUserName</h2>

                <div class="reservation-detail">
                    <span class="reservation-label">Reservation Date:</span>
                    <span class="reservation-value">
                        @SelectedReservation.Date.Value.ToString("dd MMMM yyyy") - @SelectedReservation.Time.Value.ToString("h:mm tt")
                    </span>
                </div>

                <div class="reservation-detail">
                    <span class="reservation-label">Status:</span>
                    <span class="reservation-value">@SelectedReservation.Status</span>
                </div>

                <div class="reservation-detail">
                    <span class="reservation-label">Number of People:</span>
                    <span class="reservation-value">@SelectedReservation.Pax</span>
                </div>

                <div class="reservation-detail">
                    <span class="reservation-label">Remarks:</span>
                    <span class="reservation-value">
                        @(string.IsNullOrWhiteSpace(SelectedReservation.Remarks) ? "N/A" : SelectedReservation.Remarks)
                    </span>
                </div>

                <div class="modal-buttons">
                    <a class="secondary-btn" @onclick="@ViewPreOrderReceipt">
                        View Pre-Order
                    </a>
                    @switch (SelectedReservation.Status)
                    {
                        case Reservation.ReservationStatus.Pending:
                            <a class="primary-btn" @onclick="ChangeReservationStatus">
                                Confirm Booking
                            </a>
                            <a class="danger-btn" @onclick="ShowCancelReservation">
                                Cancel Booking
                            </a>
                            break;
                        case Reservation.ReservationStatus.Confirmed:
                            <a class="primary-btn" @onclick="ChangeReservationStatus">
                                Start Booking
                            </a>
                            <a class="danger-btn" @onclick="ShowCancelReservation">
                                Cancel Booking
                            </a>
                            break;
                        case Reservation.ReservationStatus.Ongoing:
                            <a class="primary-btn" @onclick="ChangeReservationStatus">
                                Complete Booking
                            </a>
                            break;
                    }
                </div>
            </div>
        </div>
    }

    @*Show Cancel Confirm Pop Up*@
    @if (showCancelReservation)
    {
        <div class="modal-backdrop" @onclick="CloseCancelReservation">

            <div class="modal-card" @onclick:stopPropagation>
                <button class="close-btn" @onclick="CloseCancelReservation">✕</button>
                <h2 style="color: #88E788">Cancel Booking:</h2>
                <p style="color: white">Are you sure of cancelling this booking?</p>
                <div class="modal-buttons">
                    <button class="secondary-btn" @onclick="CloseCancelReservation">Back</button>
                    <button class="danger-btn" @onclick="() => CancelReservation(0)">Cancel</button>
                    <button class="danger-btn" @onclick="() => CancelReservation(1)">No-Show</button>
                </div>
            </div>
        </div>

    }
    @if (cancelReservationConfirmationPopUp)
    {
        <div class="modal-backdrop" @onclick="CloseCancelReservationConfirmationPopUp">

            <div class="modal-card" @onclick:stopPropagation>
                <h2 style="color: #88E788">Booking Cancelled</h2>
                <p style="color: white">Booking has been successfully cancelled.</p>
                <div class="modal-buttons">
                    <button class="secondary-btn" @onclick="CloseCancelReservationConfirmationPopUp">Back</button>
                </div>
            </div>
        </div>

    }
    
</div>


@code {

    private List<Reservation> restaurantBookings = new();
    private List<Reservation> BookingTab = new();
    string tabHeader = "";
    private List<Review> userReviews = new();
    private List<Restaurant> restaurants;
    private string aspNetUserId;
    private bool? hasRestaurant;

    
    protected override async Task OnParametersSetAsync()
    {
        @*Get Logged In User Info*@
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.Identity?.IsAuthenticated ?? true)
        {

            NavigationManager.NavigateTo("/Account/Login");
            return;
        }
        aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        @*Fetch Reservations and Restaurants from Database*@
        using var context = DbFactory.CreateDbContext();
        SelectedRestaurant = await context.Restaurant.FirstOrDefaultAsync(r => r.RestaurantOwnerID == aspNetUserId);
        if (SelectedRestaurant != null) {
            restaurantBookings = await context.Reservation.Where(r => r.RestaurantID == SelectedRestaurant.RestaurantID).ToListAsync();
        }
        if (restaurantBookings != null)
        {
            restaurantBookings.Sort((x, y) => Nullable.Compare(x.Date, y.Date)); //sorts the restaurant bookings by a first come first serve
        }
        restaurants = await context.Restaurant.ToListAsync();
        if(SelectedRestaurant == null)
        {
            hasRestaurant = false;
        }

    }

    @*Navigate to Restaurant Page*@
    void displayRestaurant(Restaurant restaurant)
    {
        NavigationManager.NavigateTo($"/Restaurants/{restaurant.RestaurantID}");
    }

    bool ShowPopUp = false;
    Reservation? SelectedReservation;
    Restaurant SelectedRestaurant = new();
    DinesaurUserModel? SelectedUser;
    

    @*Open Reservation Details Pop Up*@
    void OpenDetails(Reservation reservation)
    {
        SelectedReservation = reservation;
        ShowPopUp = true;
        using var context = DbFactory.CreateDbContext();
        SelectedUser = context.DinesaurUser.FirstOrDefault(r => r.DinesaurUserID == SelectedReservation.CustomerID);
    }

    @*Close Reservation Details Pop Up*@
    void CloseDetails()
    {
        ShowPopUp = false;
        SelectedReservation = null;
        SelectedUser = null;
    }

    public bool showCancelReservation = false;

    private void ShowCancelReservation()
    {
        showCancelReservation = true;
    }


    private void CloseCancelReservation()
    {
        showCancelReservation = false;
    }

    private async Task CancelReservation(int state)
    {
        if (state == 0)
        {
            SelectedReservation.Status = Reservation.ReservationStatus.Cancelled;
        }
        else
        {
            SelectedReservation.Status = Reservation.ReservationStatus.Absent;
        }

        using var context = DbFactory.CreateDbContext();
        context.Attach(SelectedReservation!).State = EntityState.Modified;
        await context.SaveChangesAsync();
        CloseDetails();
        CloseCancelReservation();
        OpenCancelReservationConfirmationPopUp();
    }

    private async Task GetBookings(int tab)
    {
        switch (tab)
        {
            case 1:
                BookingTab = restaurantBookings.Where(r => r.Status == Reservation.ReservationStatus.Pending).ToList();
                tabHeader = "New";
                break;
            case 2:
                BookingTab = restaurantBookings.Where(r => r.Status == Reservation.ReservationStatus.Confirmed).ToList();
                tabHeader = "Confirmed";
                break;
            case 3:
                BookingTab = restaurantBookings.Where(r => r.Status == Reservation.ReservationStatus.Ongoing).ToList();
                tabHeader = "Ongoing";
                break;
            case 4:
                BookingTab = restaurantBookings.Where(r => r.Status == Reservation.ReservationStatus.Completed).ToList();
                tabHeader = "Completed";
                break;
            case 5:
                BookingTab = restaurantBookings.Where(r => r.Status == Reservation.ReservationStatus.Cancelled).ToList();
                tabHeader = "Cancelled";
                break;
            default:
                BookingTab = new List<Reservation>();
                break;
        }
    }

    private async Task ViewPreOrderReceipt()
    {
        NavigationManager.NavigateTo($"/Reservation/OrderList/{SelectedReservation.ReservationID}");
    }

    private async Task ChangeReservationStatus()
    {
        using var context = DbFactory.CreateDbContext();
        if (SelectedReservation.Status == Reservation.ReservationStatus.Pending)
        {
            SelectedReservation.Status = Reservation.ReservationStatus.Confirmed;
        }
        else if (SelectedReservation.Status == Reservation.ReservationStatus.Confirmed)
        {
            SelectedReservation.Status = Reservation.ReservationStatus.Ongoing;

        } else if (SelectedReservation.Status == Reservation.ReservationStatus.Ongoing)
        {
            SelectedReservation.Status = Reservation.ReservationStatus.Completed;

        }
        context.Attach(SelectedReservation!).State = EntityState.Modified;
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/Restaurant/Bookings", forceLoad: true);
    }

    public bool cancelReservationConfirmationPopUp = false;
    private void OpenCancelReservationConfirmationPopUp()
    {
        cancelReservationConfirmationPopUp = true;
    }

    private void CloseCancelReservationConfirmationPopUp()
    {
        cancelReservationConfirmationPopUp = false;
        NavigationManager.NavigateTo("/Restaurant/Bookings", forceLoad: true);
    }
}   
