@page "/foods/create"
@using Dinesaur.Data
@using Microsoft.EntityFrameworkCore
@using Dinesaur.Domain
@inject IDbContextFactory<Dinesaur.Data.DinesaurContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create</PageTitle>
<container style="text-align: center;">
<h1 style="margin-top:40px;">Add Food</h1>

<hr />
    <div class="row justify-content-center">
    <div class="col-md-4">
        <EditForm method="post" Model="Food" OnValidSubmit="AddFood" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert"/>
            <div class="mb-3">
                <label for="foodname" class="form-label" style="color:white;">Food Name:</label> 
                <InputText id="foodname" @bind-Value="Food.FoodName" class="form-control" /> 
                <ValidationMessage For="() => Food.FoodName" class="text-danger" /> 
            </div>        
            <div class="mb-3">
                    <label for="cost" class="form-label" style="color:white;">Cost:</label>
                <InputNumber id="cost" @bind-Value="Food.Cost" class="form-control" /> 
                <ValidationMessage For="() => Food.Cost" class="text-danger" /> 
            </div>        
            <div class="mb-3">
                    <label for="description" class="form-label" style="color:white;">Description:</label>
                <InputText id="description" @bind-Value="Food.Description" class="form-control" /> 
                <ValidationMessage For="() => Food.Description" class="text-danger" /> 
            </div>               
            <div class="mb-3">
                    <label for="category" class="form-label" style="color:white;">Category:</label>
                    <InputSelect id="itemcategory" @bind-Value="Food.Category" class="form-select">
                        @foreach (string category in Categories)
                        {
                            <option value="@category">@category</option>
                        }

                    </InputSelect>
                    <ValidationMessage For="() => Food.Category" class="text-danger" />
            </div>
            <div class="mb-3" hidden>
                <label for="staffid" class="form-label">StaffID:</label> 
                <InputNumber id="staffid" @bind-Value="Food.StaffID" class="form-control" /> 
                <ValidationMessage For="() => Food.StaffID" class="text-danger" /> 
            </div>        
            <div class="mb-3" hidden>
                <label for="menuid" class="form-label">MenuID:</label> 
                <InputNumber id="menuid" @bind-Value="Food.MenuID" class="form-control" /> 
                <ValidationMessage For="() => Food.MenuID" class="text-danger" /> 
            </div>        
            <button type="submit" class="btn btn-primary">Create</button>
        </EditForm>
    </div>
</div>
</container>
@code {
    [SupplyParameterFromForm]
    private Food Food { get; set; } = new();
    private List<string> Categories = new List<string>();
    @inject AuthenticationStateProvider authenticationStateProvider
    private DinesaurContext context = default!;
    // To protect from overposting attacks, see https://learn.microsoft.com/aspnet/core/blazor/forms/#mitigate-overposting-attacks.
    private async Task AddFood()
    {
        using var context = DbFactory.CreateDbContext();
        context.Food.Add(Food);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/foods");
    }
    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var aspNetUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        context = DbFactory.CreateDbContext();
        await using var db = await DbFactory.CreateDbContextAsync();
        var CheckForRestaurantId = await db.Restaurant
        .Where(r => r.RestaurantOwnerID == aspNetUserId)
        .Select(r => r.RestaurantID)
        .SingleOrDefaultAsync();
        var ListofCategories = await db.Menu
        .Where(m => m.RestaurantID == CheckForRestaurantId)
        .Select(m => m.Catergories)
        .SingleOrDefaultAsync();
        Categories = ListofCategories;
    }
    }
